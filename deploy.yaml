---
  - hosts: all
    gather_facts: true
    remote_user: root
    tasks:
    - name: Create Service account for Ansible
      user:
        name: '{{ service_user }}'
        password: '{{ service_pass_enc }}'
        comment: "Ansible Service account"
        state: present

    - name: Upload Service account SSH Public key
      copy:
        src: keys/{{ service_account_key }}
        dest: /tmp/tempkey

    - name: Add Service account SSH Public key to authorized_keys
      authorized_key:
        user: '{{ service_user }}'
        state: present
        key: "{{ lookup('file', '/tmp/tempkey') }}"
 
    - name: Create regular user account
      user:
        name: '{{ regular_user }}'
        password: '{{ regular_pass_enc }}'
        comment: "{{ regular_user }}"
        state: present

    - name: Import geerlingguy.security role
      import_role:
        name: geerlingguy.security
      vars:
        security_ssh_port: 22
        security_ssh_password_authentication: "yes"
        security_sudoers_passwordless: ["{{ service_user }}"]
        security_sudoers_passworded: ["{{ regular_user }}"]
      become: true
