---
  - hosts: all
    gather_facts: true
    remote_user: root

    tasks:

    - name: Create service account for Ansible
      user:
        name: '{{ service_user }}'
        password: '{{ service_pass_enc }}'
        comment: "Ansible Service account"
        state: present

    - name: Add service account SSH Public key to authorized_keys
      authorized_key:
        user: '{{ service_user }}'
        state: present
        key: "{{ lookup('file', 'keys/{{ service_account_key }}') }}"
 
    - name: Create regular user account
      user:
        name: '{{ regular_user }}'
        password: '{{ regular_pass_enc }}'
        comment: "{{ regular_user }}"
        generate_ssh_key: yes
        ssh_key_file: .ssh/id_rsa
        ssh_key_type: ed25519
        ssh_key_comment: "{{ regular_user }}@{{ ansible_hostname }}"
        state: present

    - name: Download regular user account SSH Private key
      fetch:
        src: '/home/{{ regular_user }}/.ssh/id_rsa'
        dest: 'keys/{{ regular_user }}@{{ ansible_hostname }}'
        flat: yes

    - name: Download regular user account SSH Public key
      fetch:
        src: '/home/{{ regular_user }}/.ssh/id_rsa.pub'
        dest: 'keys/{{ regular_user }}@{{ ansible_hostname }}.pub'
        flat: yes

    - name: Add regular user account SSH Public key to authorized_keys
      authorized_key:
        user: '{{ regular_user }}'
        state: present
        key: "{{ lookup('file', 'keys/{{ regular_user }}@{{ ansible_hostname }}.pub') }}"
